{"ast":null,"code":"var _jsxFileName = \"/Users/Raid/test/testpApp3/SafeWalletFix/frontend/src/containerComponents/multisigEtherWallet/ModalTransferToken.js\";\nimport React from 'react';\nimport InitialTxHashComponent from '../../presentationalComponents/InitialTxHashComponent.js';\nimport ReceiptComponent from '../../presentationalComponents/ReceiptComponent.js';\nimport ModalContent from '../../presentationalComponents/ModalContent.js';\nimport TransferWithTokenForm from '../../presentationalComponents/TransferWithTokenForm.js';\nimport '../../css/Modal.css';\nimport { Transaction as Tx } from 'ethereumjs-tx';\n\nclass ModalTransferToken extends React.Component {\n  constructor(props) {\n    super(props);\n\n    this.handleInputChange = event => {\n      event.preventDefault();\n      const _event$target = event.target,\n            name = _event$target.name,\n            value = _event$target.value;\n\n      switch (name) {\n        case 'amountToTransfer':\n          if (event.target.validity.patternMismatch) {\n            event.target.setCustomValidity('Please input a number');\n          } else {\n            event.target.setCustomValidity('');\n          }\n\n          break;\n\n        case 'tokenTFA':\n          if (event.target.validity.tooShort) {\n            event.target.setCustomValidity('Token has to be 6 digits');\n          } else if (event.target.validity.patternMismatch) {\n            event.target.setCustomValidity('Please input a number');\n          } else {\n            event.target.setCustomValidity('');\n          }\n\n          break;\n\n        case 'privateKey':\n          if (event.target.validity.tooShort) {\n            event.target.setCustomValidity('Private key has to be 64 characters');\n          } else if (event.target.validity.patternMismatch) {\n            event.target.setCustomValidity('Only alphanumeric characters are allowed');\n          } else {\n            event.target.setCustomValidity('');\n          }\n\n          break;\n\n        case 'recipientAddress':\n          if (event.target.validity.tooShort) {\n            event.target.setCustomValidity('Public key has to be 42 characters');\n          } else if (event.target.validity.patternMismatch) {\n            event.target.setCustomValidity('Public key has to start with \"0x\"');\n          } else {\n            event.target.setCustomValidity('');\n          }\n\n          break;\n\n        default:\n          break;\n      }\n\n      this.setState({\n        [name]: value\n      });\n    };\n\n    this.handleSubmit = event => {\n      event.preventDefault();\n      this.transfer(this.state.amountToTransfer, this.state.recipientAddress, this.state.privateKey, this.state.tokenTFA);\n      document.getElementById('TransferFormToken').reset();\n    };\n\n    this.openModal = () => {\n      this.setState({\n        isOpen: true\n      });\n    };\n\n    this.closeModal = () => {\n      this.setState({\n        isOpen: false\n      });\n    };\n\n    this.onKeyDown = event => {\n      return event.keyCode === 27 && this.closeModal();\n    };\n\n    this.onClickAway = event => {\n      if (this.modalNode && this.modalNode.contains(event.target)) return;\n      this.closeModal();\n    };\n\n    this.transfer = (amountToTransfer, recipientAddress, privateKey, tokenTFA) => {\n      let web3 = this.props.web3;\n      let multisig = this.props.multisig;\n      let multisigAddress = this.props.multisigAddress;\n      let modal = this;\n      let updateBalances = this.props.updateBalances;\n      let addrFrom = this.props.address;\n      const priv = Buffer.from(privateKey, 'hex'); // Getting Ethereum transaction count\n\n      web3.eth.getTransactionCount(addrFrom, (err, txCount) => {\n        // Retrieving the current nonce inside the contract\n        multisig.methods.transactionNonces(addrFrom).call({\n          from: addrFrom\n        }, (error, nonce) => {\n          if (error) {\n            console.log(error);\n          } else {\n            var xhttp = new XMLHttpRequest();\n            var data = {\n              addressFrom: addrFrom,\n              addressTo: recipientAddress,\n              amount: amountToTransfer,\n              nonce: nonce,\n              token: tokenTFA\n            };\n\n            xhttp.onreadystatechange = () => {\n              if (xhttp.readyState === 4) {\n                // request is done\n                if (xhttp.status === 200) {\n                  // successfully\n                  var obj = JSON.parse(xhttp.responseText);\n\n                  if (obj.verified) {\n                    console.log({\n                      addressFrom: addrFrom,\n                      addressTo: recipientAddress,\n                      amount: amountToTransfer,\n                      signature: obj.signature\n                    }); // Build the transaction\n\n                    web3.eth.getGasPrice().then(gasPrice => {\n                      console.log('Current gas price: ', gasPrice);\n                      multisig.methods.verifyTransaction_26e(recipientAddress, amountToTransfer, obj.signature).estimateGas({\n                        gas: gasPrice,\n                        from: addrFrom\n                      }, function (error, gasAmount) {\n                        if (error) {\n                          console.log(error);\n                        } else {\n                          console.log('Estimate of gas usage: ', gasAmount);\n                          const txObject = {\n                            nonce: web3.utils.toHex(txCount),\n                            gasLimit: web3.utils.toHex(gasAmount),\n                            gasPrice: web3.utils.toHex(gasPrice),\n                            to: multisigAddress,\n                            data: multisig.methods.verifyTransaction_26e(recipientAddress, amountToTransfer, obj.signature).encodeABI()\n                          };\n                          console.log(txObject); // Sign the transaction\n\n                          const tx = new Tx(txObject, {\n                            chain: 'ropsten',\n                            hardfork: 'petersburg'\n                          });\n                          tx.sign(priv);\n                          const serializedTransaction = tx.serialize();\n                          const rawTx = '0x' + serializedTransaction.toString('hex');\n                          console.log(rawTx); // Broadcast the transaction\n\n                          web3.eth.sendSignedTransaction(rawTx).once('transactionHash', function (hash) {\n                            console.log('Hash of transaction: ', hash);\n                            modal.setState({\n                              txHash: hash,\n                              hashReceipt: true,\n                              confirmationReceipt: false\n                            });\n                            modal.openModal();\n                          }).once('confirmation', function (confNumber, receipt) {\n                            console.log('Transaction confirmation number: ', confNumber);\n                            console.log('Second receipt of transaction: ', receipt);\n                            updateBalances();\n                            modal.setState({\n                              txReceipt: receipt,\n                              confirmationReceipt: true,\n                              hashReceipt: false\n                            });\n                            modal.openModal();\n                          }).on('error', function (error) {\n                            console.log(error);\n                          });\n                        }\n                      });\n                    });\n                  } else {\n                    alert('Wrong Token Submitted');\n                  }\n                }\n              }\n            };\n\n            xhttp.open('POST', 'http://localhost:5597/submit-transaction', true);\n            xhttp.setRequestHeader('Content-Type', 'application/json');\n            xhttp.send(JSON.stringify(data));\n          }\n        });\n      });\n    };\n\n    this.state = {\n      txHash: '',\n      txReceipt: '',\n      amountToTransfer: '',\n      recipientAddress: '',\n      privateKey: '',\n      tokenTFA: '',\n      isOpen: false,\n      hashReceipt: false,\n      confirmationReceipt: false\n    };\n  }\n\n  render() {\n    return React.createElement(\"span\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 211\n      },\n      __self: this\n    }, React.createElement(TransferWithTokenForm, {\n      handleSubmit: this.handleSubmit,\n      handleInputChange: this.handleInputChange,\n      errors: this.state.errors,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 212\n      },\n      __self: this\n    }), this.state.isOpen && React.createElement(ModalContent, {\n      closeModal: this.closeModal,\n      onKeyDown: this.onKeyDown,\n      onClickAway: this.onClickAway,\n      modalRef: n => this.modalNode = n,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 218\n      },\n      __self: this\n    }, this.state.hashReceipt ? React.createElement(InitialTxHashComponent, {\n      transactionHash: this.state.txHash,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 224\n      },\n      __self: this\n    }) : null, this.state.confirmationReceipt ? React.createElement(ReceiptComponent, {\n      transactionHash: this.state.txReceipt.transactionHash,\n      blockHash: this.state.txReceipt.blockHash,\n      blockNumber: this.state.txReceipt.blockNumber,\n      gasUsed: this.state.txReceipt.gasUsed,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 227\n      },\n      __self: this\n    }) : null));\n  }\n\n}\n\nexport default ModalTransferToken;","map":{"version":3,"sources":["/Users/Raid/test/testpApp3/SafeWalletFix/frontend/src/containerComponents/multisigEtherWallet/ModalTransferToken.js"],"names":["React","InitialTxHashComponent","ReceiptComponent","ModalContent","TransferWithTokenForm","Transaction","Tx","ModalTransferToken","Component","constructor","props","handleInputChange","event","preventDefault","target","name","value","validity","patternMismatch","setCustomValidity","tooShort","setState","handleSubmit","transfer","state","amountToTransfer","recipientAddress","privateKey","tokenTFA","document","getElementById","reset","openModal","isOpen","closeModal","onKeyDown","keyCode","onClickAway","modalNode","contains","web3","multisig","multisigAddress","modal","updateBalances","addrFrom","address","priv","Buffer","from","eth","getTransactionCount","err","txCount","methods","transactionNonces","call","error","nonce","console","log","xhttp","XMLHttpRequest","data","addressFrom","addressTo","amount","token","onreadystatechange","readyState","status","obj","JSON","parse","responseText","verified","signature","getGasPrice","then","gasPrice","verifyTransaction_26e","estimateGas","gas","gasAmount","txObject","utils","toHex","gasLimit","to","encodeABI","tx","chain","hardfork","sign","serializedTransaction","serialize","rawTx","toString","sendSignedTransaction","once","hash","txHash","hashReceipt","confirmationReceipt","confNumber","receipt","txReceipt","on","alert","open","setRequestHeader","send","stringify","render","errors","n","transactionHash","blockHash","blockNumber","gasUsed"],"mappings":"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","sourcesContent":["import React from 'react';\nimport InitialTxHashComponent from '../../presentationalComponents/InitialTxHashComponent.js';\nimport ReceiptComponent from '../../presentationalComponents/ReceiptComponent.js';\nimport ModalContent from '../../presentationalComponents/ModalContent.js';\nimport TransferWithTokenForm from '../../presentationalComponents/TransferWithTokenForm.js';\nimport '../../css/Modal.css';\nimport {Transaction as Tx} from 'ethereumjs-tx';\n\nclass ModalTransferToken extends React.Component {\n\n    constructor(props) {\n        super(props);\n        this.state = {\n            txHash: '',\n            txReceipt: '',\n            amountToTransfer: '',\n            recipientAddress: '',\n            privateKey: '',\n            tokenTFA: '',\n            isOpen: false,\n            hashReceipt: false,\n            confirmationReceipt:false\n        };\n    }\n\n    handleInputChange = (event) => {\n        event.preventDefault();\n        const { name, value } = event.target;\n\n        switch (name) {\n        case 'amountToTransfer': \n            if (event.target.validity.patternMismatch) {\n              event.target.setCustomValidity('Please input a number');\n            } else {\n              event.target.setCustomValidity('');\n            }\n            break;\n        case 'tokenTFA':\n            if (event.target.validity.tooShort) {\n                event.target.setCustomValidity('Token has to be 6 digits');\n            } else if (event.target.validity.patternMismatch) {\n              event.target.setCustomValidity('Please input a number');\n            } else {\n              event.target.setCustomValidity('');\n            }\n            break;\n        case 'privateKey':\n            if (event.target.validity.tooShort) {\n              event.target.setCustomValidity('Private key has to be 64 characters');\n            } else if (event.target.validity.patternMismatch) {\n              event.target.setCustomValidity('Only alphanumeric characters are allowed');\n            } else {\n              event.target.setCustomValidity('');\n            }\n            break;\n        case 'recipientAddress':\n            if (event.target.validity.tooShort) {\n              event.target.setCustomValidity('Public key has to be 42 characters');\n            } else if (event.target.validity.patternMismatch) {\n              event.target.setCustomValidity('Public key has to start with \"0x\"');\n            } else {\n              event.target.setCustomValidity('');\n            }\n            break;     \n        default:\n            break;\n        }\n\n        this.setState({ [name]: value });\n    }\n\n    handleSubmit = (event) => {\n        event.preventDefault();\n        this.transfer(this.state.amountToTransfer, this.state.recipientAddress, this.state.privateKey, this.state.tokenTFA);\n        document.getElementById('TransferFormToken').reset();        \n    }\n  \n    openModal = () => {\n        this.setState({ \n            isOpen: true\n        });\n    };\n\n    closeModal = () => {\n        this.setState({ \n            isOpen: false \n        });\n    };\n\n    onKeyDown = (event) => {\n        return event.keyCode === 27 && this.closeModal();\n    }\n  \n    onClickAway = (event) => {\n        if (this.modalNode && this.modalNode.contains(event.target)) return;\n        this.closeModal();\n    };\n\n    transfer = (amountToTransfer, recipientAddress, privateKey, tokenTFA) => {\n\n        let web3 = this.props.web3;\n        let multisig = this.props.multisig;\n        let multisigAddress = this.props.multisigAddress;\n        let modal = this;\n        let updateBalances = this.props.updateBalances;\n        let addrFrom = this.props.address;\n        const priv = Buffer.from(privateKey, 'hex');\n\n        // Getting Ethereum transaction count\n        web3.eth.getTransactionCount(addrFrom, (err, txCount) => {\n          // Retrieving the current nonce inside the contract\n            multisig.methods.transactionNonces(addrFrom).call({from: addrFrom}, (error, nonce) => {\n                if (error) {\n                    console.log(error);\n                } else {\n                    \n                    var xhttp = new XMLHttpRequest();\n                    var data =\n                    { addressFrom: addrFrom,\n                      addressTo: recipientAddress, \n                      amount: amountToTransfer,\n                      nonce: nonce,\n                      token: tokenTFA\n                    };\n                    xhttp.onreadystatechange = () => {\n                            if (xhttp.readyState === 4) { // request is done\n                                if (xhttp.status === 200) { // successfully\n                                    var obj = JSON.parse(xhttp.responseText);\n                                    if (obj.verified) {\n                                        console.log({ \n                                        addressFrom: addrFrom,\n                                        addressTo: recipientAddress, \n                                        amount: amountToTransfer, \n                                        signature: obj.signature});\n                                        // Build the transaction\n                                        web3.eth.getGasPrice().then((gasPrice) => {\n                                            console.log('Current gas price: ', gasPrice);    \n                                            multisig.methods.verifyTransaction_26e(recipientAddress, amountToTransfer, obj.signature).estimateGas({gas: gasPrice, from: addrFrom}, function(error, gasAmount) {\n                                                if (error) {\n                                                    console.log(error);\n                                                    \n                                                } else {\n                                                console.log('Estimate of gas usage: ', gasAmount);\n                                                \n                                                const txObject = {\n                                                    nonce: web3.utils.toHex(txCount),\n                                                    gasLimit: web3.utils.toHex(gasAmount), \n                                                    gasPrice: web3.utils.toHex(gasPrice),\n                                                    to: multisigAddress,\n                                                    data: multisig.methods.verifyTransaction_26e(recipientAddress, amountToTransfer, obj.signature).encodeABI()\n                                                };\n                                                console.log(txObject);\n\n                                                // Sign the transaction\n                                                const tx = new Tx(txObject, { chain: 'ropsten', hardfork: 'petersburg' });\n                                                tx.sign(priv);\n\n                                                const serializedTransaction = tx.serialize();\n                                                const rawTx = '0x' + serializedTransaction.toString('hex');\n                                                \n                                                console.log(rawTx);\n                                                \n                                                \n                                                // Broadcast the transaction\n                                                web3.eth.sendSignedTransaction(rawTx)\n                                                .once('transactionHash', function(hash){ \n                                                    console.log('Hash of transaction: ', hash);\n                                                    modal.setState({ \n                                                      txHash: hash,\n                                                      hashReceipt: true,\n                                                      confirmationReceipt: false                       \n                                                    });\n                                                    modal.openModal();\n                                                })\n                                                .once('confirmation', function(confNumber, receipt){ \n                                                    console.log('Transaction confirmation number: ', confNumber);\n                                                    console.log('Second receipt of transaction: ', receipt);\n                                                    updateBalances();\n                                            \n                                                    modal.setState({ \n                                                      txReceipt: receipt,\n                                                      confirmationReceipt: true, \n                                                      hashReceipt: false\n                                                    });\n                                                    modal.openModal(); \n                                                })\n                                                .on('error', function(error){ console.log(error); });\n                                                \n                                                }\n                                            });\n                                          });\n\n                                    } else {\n                                        alert('Wrong Token Submitted');\n                                    }   \n                                }\n                            }\n                        };\n                    xhttp.open('POST', 'http://localhost:5597/submit-transaction', true);\n                    xhttp.setRequestHeader('Content-Type', 'application/json');\n                    xhttp.send(JSON.stringify(data));  \n                    }\n                });\n            }\n        );\n    }\n  \n    render() {\n\n        return (\n            <span>\n            <TransferWithTokenForm \n            handleSubmit={this.handleSubmit} \n            handleInputChange={this.handleInputChange}\n            errors={this.state.errors}/>\n            {\n            this.state.isOpen && \n            <ModalContent \n            closeModal={this.closeModal} \n            onKeyDown={this.onKeyDown}\n            onClickAway={this.onClickAway}\n            modalRef={n => this.modalNode = n}> \n            {this.state.hashReceipt ? \n            <InitialTxHashComponent transactionHash={this.state.txHash} />\n            : null} \n            {this.state.confirmationReceipt ?\n            <ReceiptComponent\n            transactionHash={this.state.txReceipt.transactionHash}\n            blockHash={this.state.txReceipt.blockHash}\n            blockNumber={this.state.txReceipt.blockNumber}\n            gasUsed={this.state.txReceipt.gasUsed}/>\n            : null} \n            </ModalContent>\n            }\n            </span>\n        );\n    }\n}\n\nexport default ModalTransferToken;"]},"metadata":{},"sourceType":"module"}