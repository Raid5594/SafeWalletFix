{"ast":null,"code":"var _jsxFileName = \"/Users/Raid/test/testpApp3/SafeWalletFix/frontend/src/containerComponents/multisigEtherWallet/ModalTransferSafetyKey.js\";\nimport React from 'react';\nimport InitialTxHashComponent from '../../presentationalComponents/InitialTxHashComponent.js';\nimport ReceiptComponent from '../../presentationalComponents/ReceiptComponent.js';\nimport ModalContent from '../../presentationalComponents/ModalContent.js';\nimport TransferWithKeyForm from '../../presentationalComponents/TransferWithKeyForm.js';\nimport '../../css/Modal.css';\nimport { Transaction as Tx } from 'ethereumjs-tx';\nimport EthCrypto from 'eth-crypto';\nimport BigNumber from 'bignumber.js';\nimport { connect } from 'react-redux';\n\nclass ModalTransferSafetyKey extends React.Component {\n  constructor(props) {\n    super(props);\n\n    this.handleInputChange = event => {\n      event.preventDefault();\n      const _event$target = event.target,\n            name = _event$target.name,\n            value = _event$target.value;\n\n      switch (name) {\n        case 'amountToTransfer':\n          if (event.target.validity.patternMismatch) {\n            event.target.setCustomValidity('Please input a number');\n          } else {\n            event.target.setCustomValidity('');\n          }\n\n          break;\n\n        case 'safetyPrivateKey':\n        case 'privateKey':\n          if (event.target.validity.tooShort) {\n            event.target.setCustomValidity('Private key has to be 64 characters');\n          } else if (event.target.validity.patternMismatch) {\n            event.target.setCustomValidity('Only alphanumeric characters are allowed');\n          } else {\n            event.target.setCustomValidity('');\n          }\n\n          break;\n\n        case 'recipientAddress':\n          if (event.target.validity.tooShort) {\n            event.target.setCustomValidity('Public key has to be 42 characters');\n          } else if (event.target.validity.patternMismatch) {\n            event.target.setCustomValidity('Public key has to start with \"0x\"');\n          } else {\n            event.target.setCustomValidity('');\n          }\n\n          break;\n\n        default:\n          break;\n      }\n\n      this.setState({\n        [name]: value\n      });\n    };\n\n    this.handleSubmit = event => {\n      event.preventDefault();\n      this.transfer(this.state.amountToTransfer, this.state.recipientAddress, this.state.privateKey, this.state.safetyPrivateKey);\n      document.getElementById('TransferForm').reset();\n    };\n\n    this.openModal = () => {\n      this.setState({\n        isOpen: true\n      });\n    };\n\n    this.closeModal = () => {\n      this.setState({\n        isOpen: false\n      });\n    };\n\n    this.onKeyDown = event => {\n      return event.keyCode === 27 && this.closeModal();\n    };\n\n    this.onClickAway = event => {\n      if (this.modalNode && this.modalNode.contains(event.target)) return;\n      this.closeModal();\n    };\n\n    this.transfer = (amountToTransfer, recipientAddress, privateKey, safetyPrivateKey) => {\n      const web3 = this.props.web3;\n      const multisig = this.props.multisig;\n      const multisigAddress = this.props.multisigAddress;\n      const modal = this;\n      const updateBalances = this.props.updateBalances;\n      const addrFrom = this.props.address;\n      const priv = Buffer.from(privateKey, 'hex'); // We need it to convert large wei inputs\n\n      BigNumber.set({\n        DECIMAL_PLACES: 18\n      }); // Getting Ethereum transaction count\n\n      web3.eth.getTransactionCount(addrFrom, (err, txCount) => {\n        // Retrieving the current nonce inside the contract\n        multisig.methods.transactionNonces(addrFrom).call({\n          from: addrFrom\n        }, (error, nonce) => {\n          if (error) {\n            console.log(error);\n          } else {\n            // The next few lines go around issues with big numbers\n            let x = new BigNumber(amountToTransfer);\n            let val = web3.utils.fromWei(x.toString(10), 'ether');\n            let value = web3.utils.toWei(val.toString(), 'ether');\n            let msg = [{\n              type: \"address\",\n              value: addrFrom\n            }, {\n              type: \"address\",\n              value: recipientAddress\n            }, {\n              type: \"uint256\",\n              value: value\n            }, {\n              type: \"uint256\",\n              value: nonce.toString()\n            }];\n            console.log(msg);\n\n            const _message = EthCrypto.hash.keccak256(msg);\n\n            console.log(\"message: \".concat(_message));\n\n            const _signature = EthCrypto.sign(safetyPrivateKey, _message);\n\n            console.log(\"signature: \".concat(_signature)); // Build the transaction\n\n            web3.eth.getGasPrice().then(gasPrice => {\n              console.log('Current gas price: ', gasPrice);\n              multisig.methods.verifyTransaction_26e(recipientAddress, value, _signature).estimateGas({\n                gas: gasPrice,\n                from: addrFrom\n              }, function (error, gasAmount) {\n                if (error) {\n                  console.log(error);\n                } else {\n                  console.log('Estimate of gas usage: ', gasAmount);\n                  const txObject = {\n                    nonce: web3.utils.toHex(txCount),\n                    gasLimit: web3.utils.toHex(gasAmount),\n                    // For testing, so transactions accepted faster\n                    gasPrice: web3.utils.toHex(gasPrice),\n                    to: multisigAddress,\n                    data: multisig.methods.verifyTransaction_26e(recipientAddress, value, _signature).encodeABI()\n                  };\n                  console.log(txObject); // Sign the transaction\n\n                  const tx = new Tx(txObject, {\n                    chain: 'ropsten',\n                    hardfork: 'petersburg'\n                  });\n                  tx.sign(priv);\n                  const serializedTransaction = tx.serialize();\n                  const rawTx = '0x' + serializedTransaction.toString('hex');\n                  console.log(rawTx); // Broadcast the transaction\n\n                  web3.eth.sendSignedTransaction(rawTx).once('transactionHash', function (hash) {\n                    console.log('Hash of transaction: ', hash);\n                    modal.setState({\n                      txHash: hash,\n                      hashReceipt: true,\n                      confirmationReceipt: false\n                    });\n                    modal.openModal();\n                  }).once('confirmation', function (confNumber, receipt) {\n                    console.log('Transaction confirmation number: ', confNumber);\n                    console.log('Second receipt of transaction: ', receipt);\n                    updateBalances(multisig);\n                    modal.setState({\n                      txReceipt: receipt,\n                      confirmationReceipt: true,\n                      hashReceipt: false\n                    });\n                    modal.openModal();\n                  }).on('error', function (error) {\n                    console.log(error);\n                  });\n                }\n              });\n            });\n          }\n        });\n      });\n    };\n\n    this.state = {\n      txHash: '',\n      txReceipt: '',\n      amountToTransfer: '',\n      recipientAddress: '',\n      privateKey: '',\n      safetyPrivateKey: '',\n      isOpen: false,\n      hashReceipt: false,\n      confirmationReceipt: false\n    };\n  }\n\n  render() {\n    return React.createElement(\"span\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 198\n      },\n      __self: this\n    }, React.createElement(TransferWithKeyForm, {\n      handleSubmit: this.handleSubmit,\n      handleInputChange: this.handleInputChange,\n      errors: this.state.errors,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 199\n      },\n      __self: this\n    }), this.state.isOpen && React.createElement(ModalContent, {\n      closeModal: this.closeModal,\n      onKeyDown: this.onKeyDown,\n      onClickAway: this.onClickAway,\n      modalRef: n => this.modalNode = n,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 205\n      },\n      __self: this\n    }, this.state.hashReceipt ? React.createElement(InitialTxHashComponent, {\n      transactionHash: this.state.txHash,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 211\n      },\n      __self: this\n    }) : null, this.state.confirmationReceipt ? React.createElement(ReceiptComponent, {\n      transactionHash: this.state.txReceipt.transactionHash,\n      blockHash: this.state.txReceipt.blockHash,\n      blockNumber: this.state.txReceipt.blockNumber,\n      gasUsed: this.state.txReceipt.gasUsed,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 214\n      },\n      __self: this\n    }) : null));\n  }\n\n}\n\nfunction mapStateToProps(state) {\n  return {\n    web3: state.data.web3,\n    address: state.data.etherAddress,\n    multisig: state.data.multisig,\n    multisigAddress: state.data.multisigAddress,\n    updateBalances: state.data.updateBalancesEther\n  };\n}\n\nexport default connect(mapStateToProps)(ModalTransferSafetyKey);","map":{"version":3,"sources":["/Users/Raid/test/testpApp3/SafeWalletFix/frontend/src/containerComponents/multisigEtherWallet/ModalTransferSafetyKey.js"],"names":["React","InitialTxHashComponent","ReceiptComponent","ModalContent","TransferWithKeyForm","Transaction","Tx","EthCrypto","BigNumber","connect","ModalTransferSafetyKey","Component","constructor","props","handleInputChange","event","preventDefault","target","name","value","validity","patternMismatch","setCustomValidity","tooShort","setState","handleSubmit","transfer","state","amountToTransfer","recipientAddress","privateKey","safetyPrivateKey","document","getElementById","reset","openModal","isOpen","closeModal","onKeyDown","keyCode","onClickAway","modalNode","contains","web3","multisig","multisigAddress","modal","updateBalances","addrFrom","address","priv","Buffer","from","set","DECIMAL_PLACES","eth","getTransactionCount","err","txCount","methods","transactionNonces","call","error","nonce","console","log","x","val","utils","fromWei","toString","toWei","msg","type","_message","hash","keccak256","_signature","sign","getGasPrice","then","gasPrice","verifyTransaction_26e","estimateGas","gas","gasAmount","txObject","toHex","gasLimit","to","data","encodeABI","tx","chain","hardfork","serializedTransaction","serialize","rawTx","sendSignedTransaction","once","txHash","hashReceipt","confirmationReceipt","confNumber","receipt","txReceipt","on","render","errors","n","transactionHash","blockHash","blockNumber","gasUsed","mapStateToProps","etherAddress","updateBalancesEther"],"mappings":"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","sourcesContent":["import React from 'react';\nimport InitialTxHashComponent from '../../presentationalComponents/InitialTxHashComponent.js';\nimport ReceiptComponent from '../../presentationalComponents/ReceiptComponent.js';\nimport ModalContent from '../../presentationalComponents/ModalContent.js';\nimport TransferWithKeyForm from '../../presentationalComponents/TransferWithKeyForm.js';\nimport '../../css/Modal.css';\nimport {Transaction as Tx} from 'ethereumjs-tx';\nimport EthCrypto from 'eth-crypto';\nimport BigNumber from 'bignumber.js';\nimport { connect } from 'react-redux';\n\nclass ModalTransferSafetyKey extends React.Component {\n\n    constructor(props) {\n        super(props);\n        this.state = {\n            txHash: '',\n            txReceipt: '',\n            amountToTransfer: '',\n            recipientAddress: '',\n            privateKey: '',\n            safetyPrivateKey: '',\n            isOpen: false,\n            hashReceipt: false,\n            confirmationReceipt:false\n        };\n    }\n\n    handleInputChange = (event) => {\n        event.preventDefault();\n        const { name, value } = event.target;\n\n        switch (name) {\n        case 'amountToTransfer': \n            if (event.target.validity.patternMismatch) {\n                event.target.setCustomValidity('Please input a number');\n            } else {\n                event.target.setCustomValidity('');\n            }  \n            break;\n        case 'safetyPrivateKey':\n        case 'privateKey':\n            if (event.target.validity.tooShort) {\n                event.target.setCustomValidity('Private key has to be 64 characters');\n            } else if (event.target.validity.patternMismatch) {\n                event.target.setCustomValidity('Only alphanumeric characters are allowed');\n            } else {\n                event.target.setCustomValidity('');\n            }\n            break;\n        case 'recipientAddress':\n            if (event.target.validity.tooShort) {\n                event.target.setCustomValidity('Public key has to be 42 characters');\n            } else if (event.target.validity.patternMismatch) {\n                event.target.setCustomValidity('Public key has to start with \"0x\"');\n            } else {\n                event.target.setCustomValidity('');\n            }\n            break;     \n        default:\n            break;\n        }\n\n        this.setState({ [name]: value });\n    }\n\n    handleSubmit = (event) => {\n        event.preventDefault();\n        this.transfer(this.state.amountToTransfer, this.state.recipientAddress, this.state.privateKey, this.state.safetyPrivateKey);\n        document.getElementById('TransferForm').reset();    \n    }\n  \n    openModal = () => {\n        this.setState({ \n            isOpen: true \n        });\n    };\n\n    closeModal = () => {\n        this.setState({ \n            isOpen: false \n        });\n    };\n\n    onKeyDown = (event) => {\n        return event.keyCode === 27 && this.closeModal();\n    }\n  \n    onClickAway = (event) => {\n        if (this.modalNode && this.modalNode.contains(event.target)) return;\n        this.closeModal();\n    };\n\n    transfer = (amountToTransfer, recipientAddress, privateKey, safetyPrivateKey) => {\n\n        const web3 = this.props.web3;\n        const multisig = this.props.multisig;\n        const multisigAddress = this.props.multisigAddress;\n        const modal = this;\n        const updateBalances = this.props.updateBalances;\n        const addrFrom = this.props.address;\n        const priv = Buffer.from(privateKey, 'hex');\n        // We need it to convert large wei inputs\n        BigNumber.set({ DECIMAL_PLACES: 18 }); \n\n        // Getting Ethereum transaction count\n        web3.eth.getTransactionCount(addrFrom, (err, txCount) => {\n            // Retrieving the current nonce inside the contract\n            multisig.methods.transactionNonces(addrFrom).call({from: addrFrom}, (error, nonce) => {\n                if (error) {\n                    console.log(error);\n                } else {\n                    \n                    // The next few lines go around issues with big numbers\n                    let x = new BigNumber(amountToTransfer);\n                    let val = web3.utils.fromWei(x.toString(10), 'ether');\n                    let value = web3.utils.toWei(val.toString(), 'ether');\n                    \n                    let msg = [\n                      { type: \"address\", value: addrFrom},\n                      { type: \"address\", value: recipientAddress},\n                      { type: \"uint256\", value: value},\n                      { type: \"uint256\", value: nonce.toString()}\n                    ];\n\n                    console.log(msg);\n                    const _message = EthCrypto.hash.keccak256(msg); \n                    console.log(`message: ${_message}`);\n                    \n                    const _signature = EthCrypto.sign(safetyPrivateKey, _message);\n\n                    console.log(`signature: ${_signature}`);\n                    // Build the transaction\n                    web3.eth.getGasPrice().then((gasPrice) => {\n                        console.log('Current gas price: ', gasPrice);    \n                        multisig.methods.verifyTransaction_26e(recipientAddress, value, _signature).estimateGas({gas: gasPrice, from: addrFrom}, function(error, gasAmount) {\n                            if (error) {\n                                console.log(error);\n                                \n                            } else {\n                            console.log('Estimate of gas usage: ', gasAmount);\n                            \n                            const txObject = {\n                                nonce: web3.utils.toHex(txCount),\n                                gasLimit: web3.utils.toHex(gasAmount), // For testing, so transactions accepted faster\n                                gasPrice: web3.utils.toHex(gasPrice),\n                                to: multisigAddress,\n                                data: multisig.methods.verifyTransaction_26e(recipientAddress, value, _signature).encodeABI()\n                            };\n                            console.log(txObject);\n\n                            // Sign the transaction\n                            const tx = new Tx(txObject, { chain: 'ropsten', hardfork: 'petersburg' });\n                            tx.sign(priv);\n\n                            const serializedTransaction = tx.serialize();\n                            const rawTx = '0x' + serializedTransaction.toString('hex');\n                            \n                            console.log(rawTx);\n                            \n                            \n                            // Broadcast the transaction\n                            web3.eth.sendSignedTransaction(rawTx)\n                            .once('transactionHash', function(hash){ \n                                console.log('Hash of transaction: ', hash);\n                                modal.setState({ \n                                    txHash: hash,\n                                    hashReceipt: true,\n                                    confirmationReceipt: false                       \n                                });\n                                modal.openModal();\n                            })\n                            .once('confirmation', function(confNumber, receipt){ \n                                console.log('Transaction confirmation number: ', confNumber);\n                                console.log('Second receipt of transaction: ', receipt);\n                                updateBalances(multisig);\n                        \n                                modal.setState({ \n                                    txReceipt: receipt,\n                                    confirmationReceipt: true, \n                                    hashReceipt: false\n                                });\n                                modal.openModal(); \n                            })\n                            .on('error', function(error){ console.log(error); });\n                            \n                            }\n                        });\n                    });\n                }\n            });\n        });\n    } \n\n    render() {\n\n      return (\n          <span>\n              <TransferWithKeyForm \n              handleSubmit={this.handleSubmit} \n              handleInputChange={this.handleInputChange}\n              errors={this.state.errors}/>\n              {\n              this.state.isOpen && \n              <ModalContent \n              closeModal={this.closeModal} \n              onKeyDown={this.onKeyDown}\n              onClickAway={this.onClickAway}\n              modalRef={n => this.modalNode = n}> \n              {this.state.hashReceipt ? \n              <InitialTxHashComponent transactionHash={this.state.txHash} />\n              : null} \n              {this.state.confirmationReceipt ?\n              <ReceiptComponent\n              transactionHash={this.state.txReceipt.transactionHash}\n              blockHash={this.state.txReceipt.blockHash}\n              blockNumber={this.state.txReceipt.blockNumber}\n              gasUsed={this.state.txReceipt.gasUsed}/>\n              : null}  \n              </ModalContent>\n              }\n          </span>\n      );\n    }\n}\n\nfunction mapStateToProps(state) {\n    return { \n        web3: state.data.web3,\n        address: state.data.etherAddress,\n        multisig: state.data.multisig,\n        multisigAddress: state.data.multisigAddress,\n        updateBalances: state.data.updateBalancesEther\n    };\n}\n\nexport default connect(mapStateToProps)(ModalTransferSafetyKey);"]},"metadata":{},"sourceType":"module"}